# MathHook Test Workflow
# Runs on every PR and push to main branches
# Uses pre-built Docker container for fast, consistent builds

name: Test

on:
  pull_request:
  push:
    branches: [main, master]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # All checks run in the builder container
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      # Shell script linting
      - name: ShellCheck
        run: ./scripts/ci/run-shellcheck.sh

      # TypeScript verification
      - name: TypeScript Check
        run: ./scripts/ci/verify-typescript.sh

      # Rust checks
      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features --workspace

      - name: Check documentation
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Verify Python bindings build
  python-check:
    name: Python Bindings
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Generate bindings
        run: cargo run -p mathhook-binding-codegen -- generate --target python

      - name: Build Python bindings
        run: |
          cd crates/mathhook-python
          maturin build --release

      - name: Test import
        run: |
          pip install target/wheels/*.whl --break-system-packages
          python3 -c "import mathhook; print('Python bindings OK')"

  # Verify Node.js bindings build
  node-check:
    name: Node.js Bindings
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Generate bindings
        run: cargo run -p mathhook-binding-codegen -- generate --target node

      - name: Build Node.js bindings
        run: |
          cd crates/mathhook-node
          npm install
          npm run build

      - name: Test import
        run: |
          cd crates/mathhook-node
          node -e "const m = require('./index.js'); console.log('Node.js bindings OK')"
