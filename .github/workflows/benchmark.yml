# MathHook Cross-Platform Benchmarks
# Cost-optimized: Only runs on main push, manual dispatch, or PRs with 'perf' label
# Uses pre-built Docker container for consistent benchmark environment

name: Benchmarks

on:
  pull_request:
    types: [opened, synchronize, labeled]
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      regression_threshold:
        description: 'Fail if regression exceeds this percentage'
        required: false
        default: '10'
        type: string

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  CARGO_TERM_COLOR: always
  REGRESSION_THRESHOLD: ${{ inputs.regression_threshold || '10' }}

jobs:
  # Gate: Only run expensive benchmarks when needed
  should-run:
    name: Check if benchmarks should run
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      contents: read
      pull-requests: read
    outputs:
      run: ${{ steps.check.outputs.run }}
      reason: ${{ steps.check.outputs.reason }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Check conditions
        id: check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const script = require('./scripts/ci/js/check-benchmark-conditions.js');
            await script({ context, core });

  rust:
    name: Rust Benchmarks
    needs: should-run
    if: needs.should-run.outputs.run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: read
    outputs:
      regression_detected: ${{ steps.analyze.outputs.regression_detected }}
      regression_report: ${{ steps.analyze.outputs.report }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Restore Criterion baselines
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v5.0.1
        with:
          path: target/criterion
          key: criterion-${{ runner.os }}-${{ hashFiles('crates/mathhook-benchmarks/**/*.rs') }}
          restore-keys: |
            criterion-${{ runner.os }}-

      - name: Run benchmarks
        run: ./scripts/ci/run-rust-benchmarks.sh benchmark-results/rust.json

      - name: Analyze regression
        id: analyze
        run: ./scripts/ci/analyze-regression.sh benchmark-results/rust.json

      - uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: rust-benchmark-results
          path: benchmark-results/rust.json

      - uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: criterion-reports
          path: target/criterion/

  python:
    name: Python Benchmarks
    needs: should-run
    if: needs.should-run.outputs.run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Run benchmarks
        run: ./scripts/ci/run-python-benchmarks.sh benchmark-results/python.json

      - uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: python-benchmark-results
          path: benchmark-results/python.json

  node:
    name: Node.js Benchmarks
    needs: should-run
    if: needs.should-run.outputs.run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Run benchmarks
        run: ./scripts/ci/run-node-benchmarks.sh benchmark-results/node.json

      - uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: node-benchmark-results
          path: benchmark-results/node.json

  # Regression gate - warns if significant regression detected
  regression-gate:
    name: Regression Gate
    needs: [rust, python, node]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always() && needs.rust.result == 'success'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          path: artifacts

      - name: Check for regressions
        id: check
        run: ./scripts/ci/check-regression-gate.sh "${{ needs.rust.outputs.regression_detected }}" "${{ needs.rust.outputs.regression_report }}"

      - name: Post regression warning
        if: github.event_name == 'pull_request' && steps.check.outputs.failed == '1'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const script = require('./scripts/ci/js/post-regression-warning.js');
            await script({ github, context, threshold: process.env.REGRESSION_THRESHOLD });

  deploy:
    name: Deploy Dashboard
    needs: [rust, python, node]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    container:
      image: ghcr.io/ahmedmashour/mathhook-builder:latest
    permissions:
      contents: write
      pages: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          path: artifacts

      - name: Generate dashboard
        run: ./scripts/ci/generate-dashboard.sh artifacts gh-pages

      - uses: peaceiris/actions-gh-pages@47f197a2200bb9de68ba5f48fad1c088eb1c4a32  # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Update benchmark results [skip ci]"

  pr-comment:
    name: PR Comment
    needs: [rust, python, node]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Post benchmark results
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const script = require('./scripts/ci/js/pr-benchmark-comment.js');
            await script({
              github,
              context,
              results: {
                rust: '${{ needs.rust.result }}',
                python: '${{ needs.python.result }}',
                node: '${{ needs.node.result }}'
              }
            });

  # Skip notification - informs users when benchmarks are skipped
  skip-notification:
    name: Benchmark Skip Notice
    needs: should-run
    if: needs.should-run.outputs.run == 'false' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Add skip comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const script = require('./scripts/ci/js/post-benchmark-skip-notice.js');
            await script({ github, context });
