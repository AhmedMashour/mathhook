# MathHook Release Rollback
# Emergency rollback for failed releases

name: Rollback Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to yank/deprecate (e.g., 0.1.5)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback (alphanumeric, spaces, punctuation only)'
        required: true
        type: string
      targets:
        description: 'Registries to rollback'
        required: true
        type: choice
        options:
          - all
          - crates-only
          - pypi-only
          - npm-only

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.validate.outputs.version }}
      reason: ${{ steps.validate.outputs.reason }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Validate and sanitize inputs
        id: validate
        run: ./scripts/ci/validate-rollback-inputs.sh "${{ inputs.version }}" "${{ inputs.reason }}"

  confirm:
    name: Confirm Rollback
    needs: validate-inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      confirmed: ${{ steps.confirm.outputs.confirmed }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Confirm action
        id: confirm
        run: ./scripts/ci/confirm-rollback.sh "${{ needs.validate-inputs.outputs.version }}" "${{ needs.validate-inputs.outputs.reason }}" "${{ inputs.targets }}"

  rollback-crates:
    name: Yank from crates.io
    needs: confirm
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: inputs.targets == 'all' || inputs.targets == 'crates-only'
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7  # stable

      - name: Yank crates
        run: ./scripts/ci/rollback-crates.sh "${{ inputs.version }}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  rollback-npm:
    name: Deprecate on npm
    needs: confirm
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: inputs.targets == 'all' || inputs.targets == 'npm-only'
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Deprecate package
        run: ./scripts/ci/rollback-npm.sh "${{ inputs.version }}" "${{ inputs.reason }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  rollback-pypi:
    name: Note PyPI status
    needs: validate-inputs
    runs-on: ubuntu-latest
    if: inputs.targets == 'all' || inputs.targets == 'pypi-only'
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: PyPI rollback note
        run: ./scripts/ci/pypi-rollback-note.sh "${{ needs.validate-inputs.outputs.version }}" "${{ needs.validate-inputs.outputs.reason }}"

  create-issue:
    name: Create Tracking Issue
    needs: [rollback-crates, rollback-npm, rollback-pypi]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Create issue
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const script = require('./scripts/ci/js/create-rollback-issue.js');
            await script({
              github,
              context,
              version: '${{ inputs.version }}',
              reason: '${{ inputs.reason }}',
              targets: '${{ inputs.targets }}',
              actor: '${{ github.actor }}',
              runId: '${{ github.run_id }}',
              serverUrl: '${{ github.server_url }}',
              cratesResult: '${{ needs.rollback-crates.result }}',
              npmResult: '${{ needs.rollback-npm.result }}',
              pypiResult: '${{ needs.rollback-pypi.result }}'
            });
