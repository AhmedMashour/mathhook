# Agent 2.1A: Parser & Grammar Symbol Migration

## Mission
Migrate Symbol::new() uses in parser and grammar files to the symbol!() macro. This agent handles **the highest-density file** (parser/grammar.rs with 62 uses).

## Context
- **Wave**: 2.1 - Symbol Constructor Migration Part 1
- **Target**: Reduce 227 → 114 Symbol::new() uses (50% reduction)
- **Agent Scope**: Parser and grammar files (~62 uses)
- **Priority**: MANDATORY (CLAUDE.md Priority 1)

## Files Assigned
Primary focus:
- `crates/mathhook-core/src/parser/grammar.rs` (62 uses)
- `crates/mathhook-core/src/parser/lexer/` (if any)
- `crates/mathhook-core/src/parser/*.rs` (related parser files)

## Critical Constraints

### CLAUDE.md Compliance
**PRIORITY 1 (MANDATORY)**: Symbol Creation Rules
- ❌ **NEVER** use `Symbol::new()` in application code
- ✅ **ALWAYS** use `symbol!(x)` macro for scalar symbols
- ✅ Use `symbol!(A; matrix)` for matrix symbols
- ✅ Use `symbol!(p; operator)` for operator symbols
- ✅ Use `symbol!(i; quaternion)` for quaternion symbols

**Exception**: `Symbol::new()` is ONLY allowed in:
- Macro implementations (`macros/expressions.rs`)
- Test code that specifically tests Symbol constructors
- This file is auto-generated parser code, so migration IS required

### Grammar.rs Special Handling
**WARNING**: `parser/grammar.rs` is **auto-generated by LALRPOP**.

**Strategy**:
1. First, check if Symbol::new() uses are in the LALRPOP grammar source (`parser/grammar.lalrpop`)
2. If YES: Modify `grammar.lalrpop` and regenerate with: `lalrpop crates/mathhook-core/src/parser/grammar.lalrpop`
3. If NO: The uses are in the generated code, which means the grammar source already uses symbol!() - verify this first

**Do NOT** manually edit `grammar.rs` - it will be overwritten on next build.

## Migration Patterns

### Pattern 1: Simple Symbol Creation
```rust
// ❌ Before:
let x = Symbol::new("x");

// ✅ After:
let x = symbol!(x);
```

### Pattern 2: Symbols in Loops (DO NOT use macro!)
```rust
// ❌ WRONG - macro sees token "var", not value:
for var in vars {
    let sym = symbol!(var);  // Creates Symbol::new("var")!
}

// ✅ CORRECT - use explicit API for runtime variables:
for var in vars {
    let sym = Symbol::new(var);  // Keep as-is if 'var' is runtime variable
}
```

### Pattern 3: Symbol with Type
```rust
// ❌ Before:
let A = Symbol::matrix("A");

// ✅ After:
let A = symbol!(A; matrix);
```

### Pattern 4: In Function Arguments
```rust
// ❌ Before:
parse_term(Symbol::new("x"), context)

// ✅ After:
parse_term(symbol!(x), context)
```

## Verification Steps

After migration, verify:

1. **Count Check**:
   ```bash
   # Should show significant reduction in grammar.rs
   rg "Symbol::new\(" crates/mathhook-core/src/parser/grammar.rs -c
   ```

2. **Build Check**:
   ```bash
   # Rebuild parser if you modified grammar.lalrpop
   lalrpop crates/mathhook-core/src/parser/grammar.lalrpop
   cargo build -p mathhook-core
   ```

3. **Test Check**:
   ```bash
   # Parser tests must pass
   cargo test -p mathhook-core parser
   ```

4. **No Runtime Variables in Macros**:
   ```bash
   # Should return 0
   rg "for .* in.*symbol!\(" crates/mathhook-core/src/parser/ -c
   ```

## Expected Outcomes

- **Symbol::new() uses**: Reduce from ~62 to ~31 in parser files
- **All parser tests pass**: No regressions in parsing functionality
- **Grammar regeneration**: If modified grammar.lalrpop, verify grammar.rs regenerated correctly
- **Implicit multiplication**: Verify implicit multiplication still works (2x, (a)(b), 2(x+1))

## Mathematical Correctness

Parser migration should NOT affect mathematical correctness since we're only changing how symbols are created, not their behavior. However, verify:

- Parsing still produces correct AST structure
- Symbol identity still works (same-name symbols are equal)
- No changes to parser precedence or associativity

## Quality Standards

- Zero test regressions
- Zero build errors
- Follow all migration patterns from CLAUDE.md Macro Guidelines
- Document any edge cases or special handling in code comments

## Deliverables

1. Modified files (either grammar.lalrpop or grammar.rs depending on strategy)
2. Verification command outputs
3. Summary of files modified and use-count reduction
4. Any edge cases encountered and how they were handled

## Success Criteria

- ✅ Symbol::new() uses in parser files reduced by ~50%
- ✅ All parser tests pass (cargo test -p mathhook-core parser)
- ✅ No clippy warnings introduced
- ✅ No runtime variables misused in macros
- ✅ Grammar regeneration successful (if applicable)

**START with grammar.lalrpop inspection - this determines your entire strategy!**
